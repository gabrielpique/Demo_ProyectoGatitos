@model IEnumerable<ProyectoGatitos.Models.Producto>

@{
    ViewData["Title"] = "Tienda Proyecto Gatitos";
}
<meta name="description" content="Explorá la tienda de Proyecto Gatitos. Comprá productos únicos y ayudá a financiar la adopción de gatos rescatados. ¡Apoyá nuestra causa!">
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h2 class="mb-0" style="color: #2c3e50; font-weight: 600;">
            <i class="bi bi-shop me-2"></i>Tienda Proyecto Gatitos
        </h2>
    </div>

    @if (User.IsInRole("Admin"))
    {
        <a asp-action="Create" class="btn px-2 py-2" style="background-color: #e67297; color: white; margin-bottom:20px;">
            <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
        </a>
    }

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        @foreach (var producto in Model)
        {
            <div class="col">
                <div class="card h-100 shadow-sm border-0" style="border-radius: 12px; background-color: #fce9ef;">
                    <div class="photo-gallery" data-id="@producto.Id">
                        @if (producto.Fotos != null && producto.Fotos.Any())
                        {
                            <div class="gallery-container" id="gallery-container-@producto.Id">
                                @foreach (var foto in producto.Fotos)
                                {
                                    <img src="@foto" alt="Foto de @producto.Nombre"
                                         class="gallery-image img-fluid p-3"
                                         style="object-fit: contain; height: 200px; border-radius: 16px;" />
                                }
                            </div>
                            @if (producto.Fotos.Count() > 1)
                            {
                                <div class="gallery-nav">
                                    <button class="nav-arrow prev" onclick="scrollGallery('@producto.Id', -1)">❮</button>
                                    <button class="nav-arrow next" onclick="scrollGallery('@producto.Id', 1)">❯</button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="card-img-top d-flex flex-column align-items-center justify-content-center p-4"
                                 style="height: 200px; border-radius: 16px 16px 0 0; background-color: #f8d6e1;">
                                <i class="bi bi-image" style="font-size: 2.5rem; color: #e67297;"></i>
                                <small class="mt-2" style="color: #e67297;">Imagen no disponible</small>
                            </div>
                        }
                    </div>

                    <div class="card-body d-flex flex-column pb-3">
                        <div class="mb-2">
                            <h5 class="card-title mb-1 text-center" style="color: #2c3e50; font-weight: 600;">@producto.Nombre</h5>
                            <p class="mb-2 text-center" style="color: #2c3e50; font-weight: 700; font-size: 1.1rem;">
                                $@producto.Precio.ToString("N2", System.Globalization.CultureInfo.GetCultureInfo("es-AR"))
                            </p>
                        </div>

                        <div class="mt-auto d-flex align-items-center justify-content-center">
                            <a asp-action="Details" asp-route-id="@producto.Id"
                               class="btn btn-sm px-3"
                               style="background-color: #198754; color: white;">
                                <i class="bi bi-eye me-1"></i> Ver más
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #f0c0d1;
    }

    .badge {
        border-radius: 8px;
        font-weight: 500;
    }

    .photo-gallery {
        position: relative;
        width: 100%;
        height: 200px;
        overflow: hidden;
    }

    .gallery-container {
        display: flex;
        transition: transform 0.3s ease;
        height: 100%;
    }

    .gallery-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        flex-shrink: 0;
    }

    .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
    }

    .nav-arrow {
        background-color: rgba(114, 158, 110, 0.7);
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5%;
        pointer-events: auto;
        transition: background-color 0.3s;
        z-index: 1;
    }

        .nav-arrow:hover {
            background-color: rgba(74, 112, 71, 1);
        }

        .nav-arrow.prev {
            margin-left: 5px;
        }

        .nav-arrow.next {
            margin-right: 5px;
        }

        .nav-arrow.hidden {
            visibility: hidden;
        }
</style>

@section Scripts {
    <script>
        // FUNCIONES SCROLL DE IMÁGENES
        function scrollGallery(productoId, direction) {
            const gallery = document.querySelector(`.photo-gallery[data-id="${productoId}"]`);
            const container = document.getElementById(`gallery-container-${productoId}`);
            const images = container.querySelectorAll('.gallery-image');
            const imageWidth = images[0].offsetWidth;

            const currentScroll = container.style.transform ?
                parseInt(container.style.transform.split('(')[1].split('px')[0]) || 0 : 0;

            let newScroll = currentScroll + (imageWidth * direction * -1);
            const maxScroll = (images.length - 1) * imageWidth * -1;

            // Limitar el scroll
            newScroll = Math.min(0, Math.max(maxScroll, newScroll));

            container.style.transform = `translateX(${newScroll}px)`;

            // Actualizar flechas
            updateArrows(productoId, newScroll, maxScroll);
        }

        function updateArrows(productoId, currentScroll, maxScroll) {
            const gallery = document.querySelector(`.photo-gallery[data-id="${productoId}"]`);
            const prevArrow = gallery.querySelector('.nav-arrow.prev');
            const nextArrow = gallery.querySelector('.nav-arrow.next');

            // Si no se pasan los valores, calcularlos
            if (currentScroll === undefined || maxScroll === undefined) {
                const container = document.getElementById(`gallery-container-${productoId}`);
                const images = container.querySelectorAll('.gallery-image');
                const imageWidth = images[0].offsetWidth;
                currentScroll = container.style.transform ?
                    parseInt(container.style.transform.split('(')[1].split('px')[0]) || 0 : 0;
                maxScroll = (images.length - 1) * imageWidth * -1;
            }

            // Mostrar/ocultar flechas según la posición
            if (currentScroll >= 0) {
                prevArrow.classList.add('hidden');
            } else {
                prevArrow.classList.remove('hidden');
            }

            if (currentScroll <= maxScroll) {
                nextArrow.classList.add('hidden');
            } else {
                nextArrow.classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.photo-gallery').forEach(gallery => {
                const productoId = gallery.getAttribute('data-id');
                updateArrows(productoId);
            });
        });
    </script>
}