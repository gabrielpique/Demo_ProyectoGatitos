@model ProyectoGatitos.Models.ViewModels.AdopcionVM
@using System.Security.Claims

@* @{
    ViewData["Title"] = ViewBag.Vista == "Pendientes"? "Gatos en Adopción" : "Gatos Adoptados";
    bool esRefugio = ViewBag.EsRefugio ?? false;
} *@
@{
    bool esRefugio = ViewBag.EsRefugio ?? false;
    string vista = ViewBag.Vista as string ?? "";

    if (esRefugio && vista == "Pendientes")
    {
        ViewData["Title"] = "Gatos en Adopción Refugios Externos";
    }
    else if (esRefugio && vista == "Adoptados")
    {
        ViewData["Title"] = "Gatos Adoptados Refugios Externos";
    }
    else if (!esRefugio && vista == "Pendientes")
    {
        ViewData["Title"] = "Gatos en Adopción";
    }
    else
    {
        ViewData["Title"] = "Gatos Adoptados";
    }
}


<link href="~/css/site.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<head>
    <meta name="title" content="@ViewData["Title"] - Proyecto Gatitos">
    <meta name="description" content="¿Querés adoptar un gato? En Proyecto Gatitos rescatamos gatitos y cuidamos de ellos hasta que consigan una familia. ¡Conocé a nuestros gatos en adopción hoy!">
    <link href="~/css/site.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
@section Styles {
    <style>
        :root {
            --primary: #3D5A3D; 
            --primary-light: #8BC187; 
            --accent: #F7B95A; 
            --text: #222222; 
            --text-light: #444444; 
            --bg: #f2f2f2; 
            --white: #ffffff;
            --rose: #e67297;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }


        .subtitle {
            background-color: #D7DED3; 
            color: #2F2F2F; 
            padding: 10px 20px;
            border-left: 6px solid #5F7B5C; 
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: inline-block;
        }


        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 3rem 0;
        }

        .action-item {
            background: rgba(255, 182, 193, 0.2);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.03);
            position: relative;
        }

            /* .action-item:hover {
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                border-color: var(--rose);
            } */

        .action-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .action-description {
            color: var(--text-light);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .action-link {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 1rem 0.5rem;
        }

            .action-link:hover {
                background-color: var(--primary-light);
                transform: scale(1.05);
                color: white;
            }

        .admin-actions {
            margin-top: 1rem;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .adoptado {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .disponible {
            background-color: #ffebee;
            color: #c62828;
        }

        /* GALERÍA  */
        .photo-gallery {
            position: relative;
            width: 220px;
            overflow: hidden;
            margin: 0 auto 1.5rem;
        }

        .gallery-container {
            display: flex;
            gap: 10px;
            transition: transform 0.3s ease;
        }

        .gallery-image {
            width: 220px;
            height: 220px;
            object-fit: cover;
            flex-shrink: 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .nav-arrow {
            background-color: rgba(114, 158, 110, 0.7);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 20px;
            border-radius: 5%;
            pointer-events: auto;
            transition: background-color 0.3s;
            z-index: 1;
        }

            .nav-arrow:hover {
                background-color: rgba(74, 112, 71, 1);
            }

            .nav-arrow.prev {
                margin-left: 5px;
            }

            .nav-arrow.next {
                margin-right: 5px;
            }

            .nav-arrow.hidden {
                visibility: hidden;
            }

        /* Modal  */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

            .modal.visible {
                visibility: visible;
                opacity: 1;
            }

        .modal-content {
            background-color: white;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            position: absolute;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
            margin: 0 auto;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

            .modal-content.visible {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

        @@keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #333;
            transition: color 0.2s;
        }

            .close:hover {
                color: #c62828;
            }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            color: var(--primary);
        }

        .modal-content label {
            display: block;
            margin: 10px 0 5px;
            text-align: left;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #modal-description {
            white-space: pre-line;
            line-height: 1.6;
        }

        .conocer-mas {
            font-size: 0.85em;
            transition: all 0.3s ease;
            background-color: transparent;
            color: #4A7047; 
            border: 1px solid #4A7047;
            padding: 5px 10px;
            border-radius: 6px;
            text-decoration: none;
        }

            .conocer-mas:hover {
                opacity: 1;
                background-color: rgba(74, 112, 71, 0.1); 
                color: #4A7047;
            }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-list {
            list-style: none;
            padding: 0;
            display: flex;
            gap: 8px;
        }

        .pagination-link {
            display: block;
            padding: 6px 12px;
            background-color: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

            .pagination-link:hover {
                background-color: #ddd;
            }

            .pagination-link.is-current {
                background-color: var(--rose);
                color: white;
                font-weight: bold;
            }



        @@media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .action-item {
                padding: 1.5rem;
            }

            .photo-gallery {
                width: 170px;
            }

            .gallery-image {
                width: 170px;
                height: 170px;
            }

            .admin-actions .action-link {
                padding: 0.5rem; 
                line-height: 1; 
                text-align: center; 
            }
        }
    </style>
}

<div class="main-container">
    @if (User.IsInRole("Admin"))
    {
        @if (!esRefugio)
        {
            <div style="text-align: center;">
                <a href="@Url.Action("Create", "Adopciones")" class="action-link">Nueva adopción</a>
            </div>
        }
        else
        {
            <div style="text-align: center;">
                <a href="@Url.Action("CrearDesdeRefugio", "Adopciones")" class="action-link">Nueva adopción</a>
            </div>
        }

    }
    <div class="hero-section">
        <h1>@ViewData["Title"]</h1>
        @if (ViewBag.Vista == "Pendientes")
        {
            <p class="subtitle">🐱 Gatos en Adopción: @Model.CantidadTotalGatos</p>
        }
        else if (ViewBag.Vista == "Adoptados")
        {
            <p class="subtitle">🏠 Gatos Adoptados: @Model.CantidadTotalGatos</p>
        }
    </div>

    <div class="action-grid">
        @foreach (var adopcion in Model.Adopciones)
        {
            <div class="action-item">
                <h3 class="action-title">@adopcion.Nombre</h3>
                @if (adopcion.Fotos != null && adopcion.Fotos.Any())
                {
                    <div class="photo-gallery" data-id="@adopcion.Id">
                        <div class="gallery-container" id="gallery-container-@adopcion.Id">
                            @foreach (var foto in adopcion.Fotos)
                            {
                                <img src="@foto" alt="Gato @adopcion.Nombre en adopción" class="gallery-image" />
                            }
                        </div>
                        <div class="gallery-nav">
                            <button class="nav-arrow prev" onclick="scrollGallery('@adopcion.Id', -1)">❮</button>
                            <button class="nav-arrow next" onclick="scrollGallery('@adopcion.Id', 1)">❯</button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="photo-gallery">
                        <i class="fas fa-cat" style="font-size: 2.5rem; color: var(--primary); line-height: 220px;"></i>
                    </div>
                }
                <p><strong>Edad: </strong>@adopcion.Edad</p>
                @if (adopcion.Sexo == ProyectoGatitos.Enums.SexoEnum.Otro)
                {
                    <p><strong>Sexo:</strong> @adopcion.SexoPersonalizado</p>
                }
                else
                {
                    <p><strong>Sexo:</strong> @adopcion.Sexo</p>
                }

                @if (esRefugio)
                {
                    <p><strong>Refugio: </strong>@adopcion.NombreRefugio</p>
                    <p><strong>Contacto: </strong>@adopcion.ContactoRefugio</p>
                }
                
                @if (adopcion.Adoptado)
                {
                    <p class="action-description">

                        <span>Adoptado por: @adopcion.PersonaQueAdopto</span>

                    </p>
                }
                

                <a href="/adopcion/@adopcion.Id" class="action-link conocer-mas">Conocé a @adopcion.Nombre ❤️</a>

                @if (!adopcion.Adoptado && !User.IsInRole("Admin"))
                {
                    <a href="/requisitos"
                       class="action-link">Adoptar</a>
                }

                @if (User.IsInRole("Admin"))
                {
                    <div class="admin-actions">
                        <a href="@Url.Action("Edit", new { id = adopcion.Id, origen = ViewBag.Vista })"
                           class="action-link">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="@Url.Action("Delete", new { id = adopcion.Id, origen = ViewBag.Vista })"
                           class="action-link">
                            <i class="fas fa-trash"></i>
                        </a>

                        @if (!adopcion.Adoptado)
                        {
                            <a href="#"
                               class="action-link"
                               onclick="openAdoptionModal(@adopcion.Id)">
                                <i class="fas fa-check"></i>
                            </a>
                        }
                    </div>
                }
            </div>
        }
    </div>
    <nav class="pagination">
        <ul class="pagination-list">
            @if (Model.CurrentPage > 1)
            {
                <li>
                    <a asp-action="@Model.NombreAccion" asp-route-page="@(Model.CurrentPage - 1)" class="pagination-link">&laquo;</a>
                </li>
            }

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li>
                    <a asp-action="@Model.NombreAccion"
                       asp-route-page="@i"
                       class="pagination-link @(i == Model.CurrentPage ? "is-current" : "")">
                        @i
                    </a>
                </li>
            }

            @if (Model.CurrentPage < Model.TotalPages)
            {
                <li>
                    <a asp-action="@Model.NombreAccion" asp-route-page="@(Model.CurrentPage + 1)" class="pagination-link">&raquo;</a>
                </li>
            }
        </ul>
    </nav>



</div>

<!-- Modal descripción -->
<div id="descriptionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDescriptionModal()">×</span>
        <h3 id="modal-title"></h3>
        <p id="modal-description"></p>
        <div class="pre-adoption-section">
            <a href="https://forms.zohopublic.com/proyectogatitos/form/ProyectoGatitos/formperma/WWhSJsutwL14Ac2xcmPdmL0ytLbDBsr68MIJpMgugrA" class="pre-adoption-link" target="_blank">
                <span>Adoptar</span>
            </a>
        </div>
    </div>
</div>

<!-- Modal confirmar adopción -->
<div id="adoptionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAdoptionModal()">×</span>
        <h2>Confirmar Adopción</h2>
        <form id="adoptionForm" method="post" action="@Url.Action("ConfirmarAdopcion")">
            <input type="hidden" id="adoptionId" name="id" />
            <label for="personaQueAdopto">Nombre del adoptante:</label>
            <input type="text" id="personaQueAdopto" name="personaQueAdopto" required />
            <button type="submit" class="button confirm">Confirmar</button>
        </form>
    </div>
</div>


@section Scripts {
    <script>
        let currentDeleteId = null;
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

        function centerModal(modal) {
            const modalContent = modal.querySelector('.modal-content');
            const viewportHeight = window.innerHeight;
            const modalHeight = modalContent.offsetHeight;
            const scrollTop = window.scrollY || window.pageYOffset;

            let topPosition = scrollTop + (viewportHeight - modalHeight) / 2;
            if (topPosition < scrollTop + 20) {
                topPosition = scrollTop + 20;
            }
            modalContent.style.top = `${topPosition}px`;
        }

        // FUNCIONES  SCROLL DE IMÁGENES
        function scrollGallery(adopcionId, direction) {
            const gallery = document.querySelector(`.photo-gallery[data-id="${adopcionId}"]`);
            const container = document.getElementById(`gallery-container-${adopcionId}`);
            const images = container.querySelectorAll('.gallery-image');
            const imageWidth = images[0].offsetWidth + 10; // Ancho de imagen + gap

            const currentScroll = container.style.transform ?
                parseInt(container.style.transform.split('(')[1].split('px')[0]) || 0 : 0;

            let newScroll = currentScroll + (imageWidth * direction * -1);
            const maxScroll = (images.length - 1) * imageWidth * -1;

            // Limitar el scroll
            newScroll = Math.min(0, Math.max(maxScroll, newScroll));

            container.style.transform = `translateX(${newScroll}px)`;

            // Actualizar flechaas
            updateArrows(adopcionId, newScroll, maxScroll);
        }

        function updateArrows(adopcionId, currentScroll, maxScroll) {
            const gallery = document.querySelector(`.photo-gallery[data-id="${adopcionId}"]`);
            const prevArrow = gallery.querySelector('.nav-arrow.prev');
            const nextArrow = gallery.querySelector('.nav-arrow.next');

            // Si no se pasan los valores, calcularlos
            if (currentScroll === undefined || maxScroll === undefined) {
                const container = document.getElementById(`gallery-container-${adopcionId}`);
                const images = container.querySelectorAll('.gallery-image');
                const imageWidth = images[0].offsetWidth + 10;
                currentScroll = container.style.transform ?
                    parseInt(container.style.transform.split('(')[1].split('px')[0]) || 0 : 0;
                maxScroll = (images.length - 1) * imageWidth * -1;
            }

            // Mostrar/ocultar flechas según la posición
            if (currentScroll >= 0) {
                prevArrow.classList.add('hidden');
            } else {
                prevArrow.classList.remove('hidden');
            }

            if (currentScroll <= maxScroll) {
                nextArrow.classList.add('hidden');
            } else {
                nextArrow.classList.remove('hidden');
            }
        }


        function openAdoptionModal(id) {
            document.getElementById("adoptionId").value = id;
            const modal = document.getElementById("adoptionModal");
            modal.style.display = "block";
            centerModal(modal);
            modal.classList.add('visible');
            modal.querySelector('.modal-content').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeAdoptionModal() {
            const modal = document.getElementById("adoptionModal");
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = "none";
                document.body.style.overflow = 'auto';
            }, 300);
        }

        function closeModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 300);
        }

        function openDescriptionModal(id, description, petName) {
            const modal = document.getElementById('descriptionModal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-description');

            title.textContent = petName;
            desc.textContent = description;

            modal.style.display = 'block';
            centerModal(modal);
            modal.classList.add('visible');
            modal.querySelector('.modal-content').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeDescriptionModal() {
            const modal = document.getElementById("descriptionModal");
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = "none";
                document.body.style.overflow = 'auto';
            }, 300);
        }


            

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this || e.target.classList.contains('close')) {
                        modal.classList.remove('visible');
                        setTimeout(() => {
                            modal.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }, 300);
                    }
                });
            });

            window.addEventListener('resize', () => {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'block') {
                        centerModal(modal);
                    }
                });
            });

            window.addEventListener('scroll', () => {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'block') {
                        centerModal(modal);
                    }
                });
            });

            document.getElementById('adoptionForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': token
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('Error en la respuesta del servidor');
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification('Adopción confirmada correctamente', 'success');
                            closeAdoptionModal();
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showNotification(data.message || 'Error al confirmar adopción', 'error');
                        }
                    })
                    .catch(error => {
                        showNotification('Error: ' + error.message, 'error');
                    });
            });

            document.querySelectorAll('.photo-gallery').forEach(gallery => {
                const adopcionId = gallery.getAttribute('data-id');
                updateArrows(adopcionId);
            });
        

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px';
            notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#F44336';
            notification.style.color = 'white';
            notification.style.borderRadius = '5px';
            notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            notification.style.zIndex = '9999';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
}